{% extends "base.html" %}

{% block title %}Approved Weekly Logs — University Supervisor{% endblock %}

{% block content %}
<div class="row g-4">
  <div class="col-12">

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
      <div>
        <div class="fw-bold fs-5">Approved Weekly Logs</div>
        <div class="text-muted small">
          Logs approved by the industry supervisor for students assigned to you.
        </div>
      </div>

      <div class="d-flex gap-2">
        <a href="{% url 'supervisor_students' %}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-people me-1"></i> My Students
        </a>
        <a href="{% url 'supervisor_approved_logs' %}" class="btn btn-light border btn-sm">
          <i class="bi bi-arrow-clockwise me-1"></i> Refresh
        </a>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header d-flex align-items-center justify-content-between">
        <span class="fw-bold"><i class="bi bi-journal-check me-1"></i> Approved Logs</span>
        <span class="badge text-bg-light border">{{ logs|length }} total</span>
      </div>

      <div class="card-body">
        {% if logs %}

          {# ✅ Group logs by student #}
          {% regroup logs by placement.request.student as student_groups %}

          <div class="d-flex flex-column gap-4">
            {% for g in student_groups %}
              <div class="border rounded-4 p-3 p-md-4 bg-white">

                {# Student header #}
                <div class="d-flex flex-column flex-md-row justify-content-between gap-2">
                  <div>
                    <div class="fw-bold">
                      <i class="bi bi-person-badge text-danger me-1"></i>
                      {{ g.grouper.reg_no }}
                      <span class="text-muted fw-normal">— {{ g.grouper.user.display_name }}</span>
                    </div>

                    {% with first_log=g.list.0 %}
                      <div class="small text-muted mt-1">
                        <i class="bi bi-building me-1"></i>
                        {{ first_log.placement.company.name }}
                      </div>
                    {% endwith %}
                  </div>

                  <div class="text-muted small">
                    <span class="badge text-bg-success">Industry Approved</span>
                    <span class="ms-2">{{ g.list|length }} log(s)</span>
                  </div>
                </div>

                <hr class="my-3">

                {# Logs for this student #}
                <div class="accordion" id="acc-student-{{ g.grouper.id }}">
                  {% for log in g.list %}
                    <div class="accordion-item">
                      <h2 class="accordion-header" id="h-{{ log.id }}">
                        <button class="accordion-button collapsed" type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#c-{{ log.id }}"
                                aria-expanded="false"
                                aria-controls="c-{{ log.id }}">
                          <div class="w-100 d-flex flex-column flex-md-row justify-content-between gap-2">
                            <div class="fw-semibold">
                              Week {{ log.week_no }}
                              <span class="text-muted fw-normal ms-2">
                                ({{ log.from_date }} → {{ log.to_date }})
                              </span>
                            </div>
                            <div class="small text-muted">
                              {% if log.company_action_at %}
                                <i class="bi bi-clock me-1"></i>{{ log.company_action_at|date:"Y-m-d H:i" }}
                              {% else %}
                                —
                              {% endif %}
                            </div>
                          </div>
                        </button>
                      </h2>

                      <div id="c-{{ log.id }}" class="accordion-collapse collapse"
                           aria-labelledby="h-{{ log.id }}"
                           data-bs-parent="#acc-student-{{ g.grouper.id }}">
                        <div class="accordion-body">

                          <div class="d-flex flex-column flex-md-row justify-content-between gap-2 mb-3">
                            <div class="fw-semibold">
                              <i class="bi bi-table me-1"></i> Daily Activities (Mon – Fri)
                            </div>

                            <div class="d-flex gap-2">
                              {% if log.attachment %}
                                <a class="btn btn-outline-danger btn-sm" href="{{ log.attachment.url }}" target="_blank" rel="noopener">
                                  <i class="bi bi-paperclip me-1"></i> Attachment
                                </a>
                              {% endif %}

                              <a class="btn btn-outline-secondary btn-sm"
                                 href="{% url 'supervisor_add_site_visit' log.placement.id %}">
                                <i class="bi bi-geo-alt-fill me-1"></i> Add Site Visit
                              </a>
                            </div>
                          </div>

                          {# ✅ Daily table #}
                          <div class="table-responsive mb-3">
                            <table class="table table-bordered align-middle mb-0">
                              <thead class="table-light">
                                <tr>
                                  <th style="width:140px;">Day</th>
                                  <th>Work Assignments</th>
                                  <th>Activities / Steps</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for e in log.entries.all %}
                                  <tr>
                                    <td class="fw-semibold">{{ e.get_day_display }}</td>
                                    <td style="white-space: pre-wrap;">{{ e.work_assignment|default:"—" }}</td>
                                    <td style="white-space: pre-wrap;">{{ e.activities_steps|default:"—" }}</td>
                                  </tr>
                                {% empty %}
                                  <tr>
                                    <td colspan="3" class="text-muted small">No daily entries found for this log.</td>
                                  </tr>
                                {% endfor %}
                              </tbody>
                            </table>
                          </div>

                         {# ✅ Challenges + Lessons (HARD left-aligned) #}
                          <div class="row g-3 mt-3 supervisor-remarks">
                            <div class="col-12 col-lg-6 supervisor-remark-col">
                              <div class="fw-semibold mb-1 d-flex align-items-center gap-2">
                                <i class="bi bi-exclamation-triangle"></i> <span>Challenges</span>
                              </div>

                              <div class="remarks-text small text-muted">
                                {{ log.challenges|default:"—" }}
                              </div>
                            </div>

                            <div class="col-12 col-lg-6 supervisor-remark-col">
                              <div class="fw-semibold mb-1 d-flex align-items-center gap-2">
                                <i class="bi bi-lightbulb"></i> <span>Lessons Learnt</span>
                              </div>

                              <div class="remarks-text small text-muted">
                                {{ log.lessons|default:"—" }}
                              </div>
                            </div>
                          </div>


                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>

              </div>
            {% endfor %}
          </div>

        {% else %}
          <div class="text-center py-5">
            <div class="mb-2">
              <i class="bi bi-journal-x text-danger" style="font-size:2rem;"></i>
            </div>
            <div class="fw-bold">No approved logs yet</div>
            <div class="text-muted small">
              Logs will appear here after the industry supervisor approves them.
            </div>
          </div>
        {% endif %}
      </div>
    </div>

  </div>
</div>

<style>
  /* If any parent is centering, kill it inside accordion details */
  .accordion-body,
  .accordion-body * {
    text-align: left;
  }

  /* Force the remarks section to be left aligned no matter what */
  .accordion-body .supervisor-remarks,
  .accordion-body .supervisor-remarks * {
    text-align: left !important;
  }

  /* Important: stop flex-centering from any global styles */
  .accordion-body .supervisor-remark-col{
    display: flex !important;
    flex-direction: column !important;
    align-items: flex-start !important;
    justify-content: flex-start !important;
  }

  /* Make the text span full width so it can’t look centered */
  .accordion-body .remarks-text{
    width: 100% !important;
    display: block !important;
    margin: 0 !important;
    white-space: pre-wrap !important;
    text-align: left !important;
  }
</style>

{% endblock %}
