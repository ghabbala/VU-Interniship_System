{% extends "base.html" %}

{% block title %}Submitted Evaluations — University Supervisor{% endblock %}

{% block content %}
<div class="row g-4">
  <div class="col-12">

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
      <div>
        <div class="fw-bold fs-5">Submitted Industry Evaluations</div>
        <div class="text-muted small">
          Evaluations submitted by Industry Supervisors for students assigned to you.
        </div>
      </div>

      <div class="d-flex gap-2">
        <a href="{% url 'supervisor_students' %}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-people me-1"></i> My Students
        </a>
        <a href="{% url 'supervisor_submitted_evaluations' %}" class="btn btn-light border btn-sm">
          <i class="bi bi-arrow-clockwise me-1"></i> Refresh
        </a>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header d-flex align-items-center justify-content-between">
        <span class="fw-bold"><i class="bi bi-clipboard-check me-1"></i> Submitted Evaluations</span>
        <span class="badge text-bg-light border">{{ evaluations|length }} total</span>
      </div>

      <div class="card-body">
        {% if evaluations %}

          {# ✅ Group by student #}
          {% regroup evaluations by placement.request.student as student_groups %}

          <div class="d-flex flex-column gap-4">
            {% for g in student_groups %}
              <div class="border rounded-4 p-3 p-md-4 bg-white">

                <div class="d-flex flex-column flex-md-row justify-content-between gap-2">
                  <div>
                    <div class="fw-bold">
                      <i class="bi bi-person-badge text-danger me-1"></i>
                      {{ g.grouper.reg_no }}
                      <span class="text-muted fw-normal">— {{ g.grouper.user.display_name }}</span>
                    </div>

                    {% with ev=g.list.0 %}
                      <div class="small text-muted mt-1">
                        <i class="bi bi-building me-1"></i>
                        {{ ev.placement.company.name }}
                        <span class="mx-2">•</span>
                        <i class="bi bi-person-check me-1"></i>
                        Industry Supervisor: {{ ev.supervisor_name|default:"—" }}
                      </div>
                    {% endwith %}
                  </div>

                  <div class="text-muted small">
                    <span class="badge text-bg-success">Submitted</span>
                    <span class="ms-2">{{ g.list|length }} evaluation(s)</span>
                  </div>
                </div>

                <hr class="my-3">

                <div class="accordion" id="acc-student-{{ g.grouper.id }}">
                  {% for ev in g.list %}
                    <div class="accordion-item">
                      <h2 class="accordion-header" id="h-ev-{{ ev.id }}">
                        <button class="accordion-button collapsed" type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#c-ev-{{ ev.id }}"
                                aria-expanded="false"
                                aria-controls="c-ev-{{ ev.id }}">
                          <div class="w-100 d-flex flex-column flex-md-row justify-content-between gap-2">
                            <div class="fw-semibold">
                              Evaluation — Internship Period
                              <span class="text-muted fw-normal ms-2">
                                ({{ ev.placement.start_date }} → {{ ev.placement.end_date }})
                              </span>
                            </div>

                            <div class="d-flex flex-wrap gap-2 justify-content-end align-items-center">
                              <span class="badge text-bg-light border">
                                {{ ev.total_marks }}/{{ ev.max_marks }}
                              </span>
                              <span class="badge text-bg-success">
                                {{ ev.score_out_of_10|floatformat:1 }}/10
                              </span>
                              <span class="badge text-bg-primary">
                                {{ ev.score_out_of_100|floatformat:0 }}/100
                              </span>

                              <span class="small text-muted">
                                {% if ev.submitted_at %}
                                  <i class="bi bi-clock me-1"></i>{{ ev.submitted_at|date:"Y-m-d H:i" }}
                                {% else %}
                                  —
                                {% endif %}
                              </span>
                            </div>
                          </div>
                        </button>
                      </h2>

                      <div id="c-ev-{{ ev.id }}" class="accordion-collapse collapse"
                           aria-labelledby="h-ev-{{ ev.id }}"
                           data-bs-parent="#acc-student-{{ g.grouper.id }}">
                        <div class="accordion-body eval-left">

                          <div class="alert alert-light border small mb-3">
                            <div class="fw-semibold mb-1">
                              <i class="bi bi-info-circle me-1"></i> Note
                            </div>
                            <div class="text-muted" style="white-space: pre-line;">
The purpose of this evaluation is to help students on internship to further develop their job performance.
You are encouraged to discuss your responses with the student in a positive and objective manner, just as you would review job performance with your colleagues.
This evaluation will assist in determining the student’s grade.
Your assessment of the student’s learning experience, the attainment of goals, and the professional development achieved over the service period is valued.
                            </div>
                          </div>

                          <div class="table-responsive mb-3">
                            <table class="table table-bordered align-middle mb-0">
                              <thead class="table-light">
                                <tr>
                                  <th style="width:45%;">Criteria</th>
                                  <th style="width:90px;">Score</th>
                                  <th>Comment</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr><td class="fw-semibold">1. Basic work expectations</td><td>{{ ev.basic_work_expectations }}</td><td style="white-space: pre-line;">{{ ev.basic_work_expectations_comment|default:"—" }}</td></tr>
                                <tr><td class="fw-semibold">2. Knowledge and ability to learn</td><td>{{ ev.knowledge_and_learning }}</td><td style="white-space: pre-line;">{{ ev.knowledge_and_learning_comment|default:"—" }}</td></tr>
                                <tr><td class="fw-semibold">3. Ethical awareness and conduct</td><td>{{ ev.ethical_awareness }}</td><td style="white-space: pre-line;">{{ ev.ethical_awareness_comment|default:"—" }}</td></tr>
                                <tr><td class="fw-semibold">4. Interpersonal relations</td><td>{{ ev.interpersonal_relations }}</td><td style="white-space: pre-line;">{{ ev.interpersonal_relations_comment|default:"—" }}</td></tr>
                                <tr><td class="fw-semibold">5. Communication skills</td><td>{{ ev.communication_skills }}</td><td style="white-space: pre-line;">{{ ev.communication_skills_comment|default:"—" }}</td></tr>
                                <tr><td class="fw-semibold">6. Attendance</td><td>{{ ev.attendance }}</td><td style="white-space: pre-line;">{{ ev.attendance_comment|default:"—" }}</td></tr>
                                <tr><td class="fw-semibold">7. Punctuality</td><td>{{ ev.punctuality }}</td><td style="white-space: pre-line;">{{ ev.punctuality_comment|default:"—" }}</td></tr>
                                <tr><td class="fw-semibold">8. Flexibility</td><td>{{ ev.flexibility }}</td><td style="white-space: pre-line;">{{ ev.flexibility_comment|default:"—" }}</td></tr>
                                <tr><td class="fw-semibold">9. Dependability</td><td>{{ ev.dependability }}</td><td style="white-space: pre-line;">{{ ev.dependability_comment|default:"—" }}</td></tr>
                                <tr><td class="fw-semibold">10. Culture fit</td><td>{{ ev.culture_fit }}</td><td style="white-space: pre-line;">{{ ev.culture_fit_comment|default:"—" }}</td></tr>
                                <tr><td class="fw-semibold">11. Dress code</td><td>{{ ev.dress_code }}</td><td style="white-space: pre-line;">{{ ev.dress_code_comment|default:"—" }}</td></tr>
                                <tr><td class="fw-semibold">12. Behaviour</td><td>{{ ev.behaviour }}</td><td style="white-space: pre-line;">{{ ev.behaviour_comment|default:"—" }}</td></tr>
                                <tr><td class="fw-semibold">13. Work productivity</td><td>{{ ev.work_productivity }}</td><td style="white-space: pre-line;">{{ ev.work_productivity_comment|default:"—" }}</td></tr>
                              </tbody>
                            </table>
                          </div>

                          <div class="row g-3">
                            <div class="col-12 col-lg-6">
                              <div class="fw-semibold mb-1">Recommend for employment?</div>
                              <div class="text-muted">{{ ev.recommend_employment|yesno:"YES,NO" }}</div>

                              <div class="fw-semibold mt-3 mb-1">Comment</div>
                              <div class="text-muted small" style="white-space: pre-line;">
                                {{ ev.recommend_comment|default:"—" }}
                              </div>
                            </div>

                            <div class="col-12 col-lg-6">
                              <div class="fw-semibold mb-1">Other comments / suggestions</div>
                              <div class="text-muted small" style="white-space: pre-line;">
                                {{ ev.other_comments|default:"—" }}
                              </div>
                            </div>
                          </div>

                          <hr class="my-3">

                          <div class="row g-3">
                            <div class="col-12 col-md-6">
                              <div class="fw-semibold">Supervisor Name</div>
                              <div class="text-muted small">{{ ev.supervisor_name|default:"—" }}</div>
                            </div>
                            <div class="col-12 col-md-6">
                              <div class="fw-semibold">Supervisor Signature</div>
                              <div class="text-muted small">{{ ev.supervisor_signature|default:"—" }}</div>
                            </div>
                          </div>

                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>

              </div>
            {% endfor %}
          </div>

        {% else %}
          <div class="text-center py-5">
            <div class="mb-2">
              <i class="bi bi-clipboard-x text-danger" style="font-size:2rem;"></i>
            </div>
            <div class="fw-bold">No submitted evaluations yet</div>
            <div class="text-muted small">
              Evaluations will appear here after Industry Supervisors submit them.
            </div>
          </div>
        {% endif %}
      </div>
    </div>

  </div>
</div>

<style>
  /* Prevent the "centered/indented" look */
  .eval-left, .eval-left * { text-align: left !important; }
</style>
{% endblock %}
