{% extends "base.html" %}

{% block title %}Internship Request — Victoria University{% endblock %}

{% block content %}
<div class="row g-4">
  <!-- MAIN -->
  <div class="col-12 col-lg-8">
    <div class="card">
      <div class="card-header d-flex align-items-start justify-content-between">
        <div>
          <div class="fw-bold">Internship Request</div>
          <div class="text-muted small">Period: {{ period.name }}</div>
        </div>

        {# Status badge (color based on status) #}
        {% if req.status == "draft" %}
          <span class="badge text-bg-secondary">Draft</span>
        {% elif req.status == "submitted" %}
          <span class="badge text-bg-primary">Submitted</span>
        {% elif req.status == "recommended" %}
          <span class="badge text-bg-warning">Recommended</span>
        {% elif req.status == "acceptance_uploaded" %}
          <span class="badge text-bg-info">Acceptance Uploaded</span>
        {% elif req.status == "acceptance_verified" %}
          <span class="badge text-bg-success">Acceptance Verified</span>
        {% else %}
          <span class="badge text-bg-dark">{{ req.status }}</span>
        {% endif %}
      </div>

      {% if req.status == "returned_for_acceptance" and req.coordinator_comment %}
        <div class="alert alert-danger d-flex align-items-start justify-content-between gap-3">
          <div>
            <div class="fw-semibold"><i class="bi bi-chat-left-text me-1"></i> Coordinator comment</div>
            <div class="small mb-0">{{ req.coordinator_comment }}</div>
            {% if req.coordinator_commented_at %}
              <div class="small text-muted mt-1">Sent: {{ req.coordinator_commented_at|date:"Y-m-d H:i" }}</div>
            {% endif %}
          </div>
          <a class="btn btn-danger btn-sm" href="{% url 'student_upload_acceptance' %}">
            <i class="bi bi-cloud-upload me-1"></i> Upload Acceptance
          </a>
        </div>
      {% endif %}


      <div class="card-body">
        <!-- STATUS MESSAGES -->
        {% if req.recommendation_letter %}
          <div class="alert alert-success d-flex align-items-start justify-content-between gap-3">
            <div>
              <div class="fw-semibold"><i class="bi bi-patch-check me-1"></i> Recommendation letter issued</div>
              <div class="small mb-0">Download and present it to the company to obtain an acceptance letter.</div>
            </div>

            {# ✅ SECURE DOWNLOAD (student only) #}
            <a href="{% url 'download_recommendation_letter' req.id %}" class="btn btn-success btn-sm">
              <i class="bi bi-download me-1"></i> Download
            </a>
          </div>
        {% endif %}

        {% if req.status == "recommended" %}
          <div class="alert alert-warning d-flex align-items-start justify-content-between gap-3">
            <div>
              <div class="fw-semibold"><i class="bi bi-exclamation-triangle me-1"></i> Next step: Upload acceptance letter</div>
              <div class="small mb-0">Once the company issues your acceptance letter, upload it here.</div>
            </div>
            <a class="btn btn-warning btn-sm" href="{% url 'student_upload_acceptance' %}">
              <i class="bi bi-cloud-upload me-1"></i> Upload
            </a>
          </div>
        {% endif %}

        {% if req.status == "acceptance_uploaded" %}
          <div class="alert alert-info">
            <div class="fw-semibold"><i class="bi bi-hourglass-split me-1"></i> Acceptance uploaded</div>
            <div class="small mb-0">Waiting for coordinator verification and supervisor assignment.</div>
          </div>
        {% endif %}

        {% if req.status == "acceptance_verified" %}
          <div class="alert alert-success d-flex align-items-start justify-content-between gap-3">
            <div>
              <div class="fw-semibold"><i class="bi bi-check-circle me-1"></i> Acceptance verified</div>
              <div class="small mb-0">Your placement is active. Proceed to weekly logs.</div>
            </div>
            <a class="btn btn-success btn-sm" href="{% url 'student_logs' %}">
              <i class="bi bi-journal-check me-1"></i> Weekly Logs
            </a>
          </div>
        {% endif %}

        <hr class="my-4">

        <!-- REQUEST FORM -->
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h6 class="mb-0 fw-bold">Request Details</h6>
          <span class="text-muted small">Fill accurately to avoid delays.</span>
        </div>

        {% if form.errors %}
          <div class="alert alert-danger">
            <div class="fw-semibold"><i class="bi bi-x-circle me-1"></i> Please fix the errors below</div>
            <div class="small">Some fields are missing or invalid.</div>
          </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" novalidate>
          {% csrf_token %}

          {% if form.non_field_errors %}
            <div class="alert alert-danger">{{ form.non_field_errors }}</div>
          {% endif %}

          <div class="row g-3">
            {% for field in form %}
              <div class="col-12">
                <label class="form-label fw-semibold" for="{{ field.id_for_label }}">
                  {{ field.label }}
                </label>

                {{ field }}

                {% if field.help_text %}
                  <div class="form-text">{{ field.help_text|safe }}</div>
                {% endif %}

                {% if field.errors %}
                  <div class="text-danger small mt-1">{{ field.errors }}</div>
                {% endif %}
              </div>
            {% endfor %}
          </div>

          <div class="d-flex flex-column flex-md-row gap-2 mt-4">
            <button class="btn btn-outline-secondary" type="submit" name="action" value="save"
              {% if req.status != "draft" %}disabled{% endif %}>
              <i class="bi bi-save me-1"></i> Save Draft
            </button>

            <button class="btn btn-danger" type="submit" name="action" value="submit"
              {% if req.status != "draft" %}disabled{% endif %}>
              <i class="bi bi-send me-1"></i> Submit Request
            </button>

            <a class="btn btn-light border ms-md-auto" href="{% url 'student_logs' %}">
              <i class="bi bi-journal-text me-1"></i> View Weekly Logs
            </a>
          </div>

          <div class="small text-muted mt-2">
            Submitting sends your request to the coordinator for review.
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- RIGHT SIDEBAR -->
  <div class="col-12 col-lg-4">
    <div class="card mb-4">
      <div class="card-header fw-bold">
        <i class="bi bi-list-check me-1"></i> Process Checklist
      </div>
      <div class="card-body small">
        <div class="d-flex align-items-start gap-2 mb-2">
          <i class="bi bi-1-circle text-danger"></i>
          <div>Submit internship request to the coordinator.</div>
        </div>
        <div class="d-flex align-items-start gap-2 mb-2">
          <i class="bi bi-2-circle text-danger"></i>
          <div>Collect recommendation letter from the university.</div>
        </div>
        <div class="d-flex align-items-start gap-2 mb-2">
          <i class="bi bi-3-circle text-danger"></i>
          <div>Present it to the company and obtain acceptance letter.</div>
        </div>
        <div class="d-flex align-items-start gap-2 mb-2">
          <i class="bi bi-4-circle text-danger"></i>
          <div>Upload acceptance letter for verification.</div>
        </div>
        <div class="d-flex align-items-start gap-2">
          <i class="bi bi-5-circle text-danger"></i>
          <div>Start weekly logs and submit for approval.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header fw-bold">
        <i class="bi bi-link-45deg me-1"></i> Quick Links
      </div>
      <div class="card-body d-grid gap-2">
        <a class="btn btn-outline-secondary" href="{% url 'student_logs' %}">
          <i class="bi bi-journal-check me-1"></i> Weekly Logs
        </a>

        {# Only show acceptance upload link when allowed #}
        {% if req.status == "recommended" %}
          <a class="btn btn-outline-secondary" href="{% url 'student_upload_acceptance' %}">
            <i class="bi bi-cloud-upload me-1"></i> Upload Acceptance
          </a>
        {% endif %}

        <a class="btn btn-outline-secondary" href="/dashboard/">
          <i class="bi bi-speedometer2 me-1"></i> Dashboard
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}
